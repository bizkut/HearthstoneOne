# HearthstoneOne AI - Docker Compose with CUDA Support
# 
# Prerequisites:
# 1. Install NVIDIA Container Toolkit: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html
# 2. Verify: docker run --rm --gpus all nvidia/cuda:11.8.0-base-ubuntu22.04 nvidia-smi
#
# Usage:
#   docker compose up -d              # Start server
#   docker compose run train          # Run training
#   docker compose logs -f server     # View server logs

services:
  # WebSocket inference server
  server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hearthstoneone-server
    ports:
      - "9876:9876"
    volumes:
      - ./models:/app/models:ro
      - ./logs:/app/logs
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONUNBUFFERED=1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    command: ["python", "runtime/websocket_server.py", "--host", "0.0.0.0", "--port", "9876", "--model", "/app/models/best_model.pt"]

  # Training service (run on-demand)
  train:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hearthstoneone-train
    volumes:
      - ./models:/app/models
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONUNBUFFERED=1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    profiles:
      - training
    command: ["python", "training/trainer.py", "--epochs", "100", "--output", "/app/models"]

  # Imitation learning (Transformer)
  imitation:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hearthstoneone-imitation
    volumes:
      - ./models:/app/models
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONUNBUFFERED=1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    profiles:
      - training
    command: ["python", "training/imitation_trainer.py", "--data", "/app/data/replays.json", "--epochs", "50", "--output", "/app/models/transformer_model.pt"]

  # Replay parser (CPU only)
  parser:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hearthstoneone-parser
    volumes:
      - ./data:/app/data
    profiles:
      - tools
    command: ["python", "training/replay_parser.py", "/app/data/replays", "--output", "/app/data/replays.json"]
